
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống lấy số thứ tự</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, set, onValue, get, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyALscDHNIWUlhVSDCQfyUtQV_mXGGBlDb8",
            authDomain: "datlich-af6a6.firebaseapp.com",
            databaseURL: "https://datlich-af6a6-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "datlich-af6a6",
            storageBucket: "datlich-af6a6.firebasestorage.app",
            messagingSenderId: "1048497637391",
            appId: "1:1048497637391:web:9e3f85457fa1aa08ecbb7a",
            measurementId: "G-DTEDFFQ6KR"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // DOM elements
        const getNumberBtn = document.getElementById('getNumberBtn');
        const currentNumberDisplay = document.getElementById('currentNumber');
        const yourNumberDisplay = document.getElementById('yourNumber');
        const statusMessage = document.getElementById('statusMessage');
        const userNameInput = document.getElementById('userName');
        const userPhoneInput = document.getElementById('userPhone');
        const userInfoForm = document.getElementById('userInfoForm');

        // References to Firebase paths
        const queueRef = ref(database, 'queue');
        const currentNumberRef = ref(database, 'currentNumber');

        // Initialize current number if not exists
        get(currentNumberRef).then((snapshot) => {
            if (!snapshot.exists()) {
                set(currentNumberRef, 0);
            }
        });

        // Listen for current number changes
        onValue(currentNumberRef, (snapshot) => {
            const currentNumber = snapshot.val() || 0;
            currentNumberDisplay.textContent = currentNumber;
        });

        // Validation function
        function validateUserInfo() {
            const name = userNameInput.value.trim();
            const phone = userPhoneInput.value.trim();
            
            if (!name) {
                statusMessage.textContent = 'Vui lòng nhập họ và tên!';
                statusMessage.className = 'text-red-600 font-medium';
                userNameInput.focus();
                return false;
            }
            
            if (!phone) {
                statusMessage.textContent = 'Vui lòng nhập số điện thoại!';
                statusMessage.className = 'text-red-600 font-medium';
                userPhoneInput.focus();
                return false;
            }
            
            // Basic phone validation (Vietnamese phone numbers)
            const phoneRegex = /^(0|\+84)[3-9][0-9]{8}$/;
            if (!phoneRegex.test(phone)) {
                statusMessage.textContent = 'Số điện thoại không hợp lệ!';
                statusMessage.className = 'text-red-600 font-medium';
                userPhoneInput.focus();
                return false;
            }
            
            return true;
        }

        // Get new number function
        getNumberBtn.addEventListener('click', async () => {
            try {
                // Validate user information
                if (!validateUserInfo()) {
                    return;
                }

                getNumberBtn.disabled = true;
                getNumberBtn.textContent = 'Đang xử lý...';

                // Get current queue
                const queueSnapshot = await get(queueRef);
                let lastNumber = 0;
                
                if (queueSnapshot.exists()) {
                    const queueData = queueSnapshot.val();
                    const numbers = Object.values(queueData).map(item => item.number);
                    lastNumber = Math.max(...numbers, 0);
                }

                // Create new number
                const newNumber = lastNumber + 1;
                const newTicketRef = push(queueRef);
                
                await set(newTicketRef, {
                    number: newNumber,
                    timestamp: Date.now(),
                    status: 'waiting',
                    userName: userNameInput.value.trim(),
                    userPhone: userPhoneInput.value.trim()
                });

                // Show user's number
                yourNumberDisplay.textContent = newNumber;
                statusMessage.textContent = `Bạn đã lấy số ${newNumber}. Vui lòng chờ đến lượt!`;
                statusMessage.className = 'text-green-600 font-medium';

                // Save to localStorage (but keep form visible)
                localStorage.setItem('userNumber', newNumber);
                localStorage.setItem('userName', userNameInput.value.trim());
                localStorage.setItem('userPhone', userPhoneInput.value.trim());
                
                // Clear form for next use
                userNameInput.value = '';
                userPhoneInput.value = '';

            } catch (error) {
                console.error('Error getting number:', error);
                statusMessage.textContent = 'Có lỗi xảy ra. Vui lòng thử lại!';
                statusMessage.className = 'text-red-600 font-medium';
            } finally {
                getNumberBtn.disabled = false;
                getNumberBtn.textContent = 'Lấy số';
            }
        });

        // Check if user has a number in localStorage
        const savedNumber = localStorage.getItem('userNumber');
        const savedName = localStorage.getItem('userName');
        const savedPhone = localStorage.getItem('userPhone');
        
        if (savedNumber) {
            yourNumberDisplay.textContent = savedNumber;
            statusMessage.textContent = `Số của bạn: ${savedNumber}. Vui lòng chờ đến lượt!`;
            statusMessage.className = 'text-blue-600 font-medium';
            
            // Populate fields for reference (but keep form visible)
            if (savedName) userNameInput.value = savedName;
            if (savedPhone) userPhoneInput.value = savedPhone;
        }
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Hệ thống lấy số thứ tự</h1>
            <p class="text-gray-600">Lấy số online và theo dõi tiến độ phục vụ</p>
        </div>

        <!-- Main Content -->
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-8">
            <!-- Current Number Display -->
            <div class="text-center mb-8">
                <h2 class="text-lg font-semibold text-gray-700 mb-2">Số đang phục vụ</h2>
                <div class="text-6xl font-bold text-blue-600 mb-2" id="currentNumber">0</div>
                <p class="text-gray-500">Cập nhật theo thời gian thực</p>
            </div>

            <!-- Your Number Display -->
            <div class="text-center mb-8 p-4 bg-gray-50 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Số của bạn</h3>
                <div class="text-4xl font-bold text-green-600 mb-2" id="yourNumber">--</div>
                <p class="text-sm text-gray-500" id="statusMessage">Chưa có số</p>
            </div>

            <!-- User Information Form -->
            <div id="userInfoForm" class="mb-8">
                <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">Thông tin cá nhân</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Họ và tên *</label>
                        <input 
                            type="text" 
                            id="userName"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Nhập họ và tên của bạn"
                            required
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Số điện thoại *</label>
                        <input 
                            type="tel" 
                            id="userPhone"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Nhập số điện thoại"
                            required
                        >
                    </div>
                </div>
            </div>

            <!-- Get Number Button -->
            <div class="text-center">
                <button 
                    id="getNumberBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-200 shadow-md hover:shadow-lg"
                >
                    Lấy số
                </button>
            </div>

        </div>

        <!-- Instructions -->
        <div class="max-w-md mx-auto mt-8 bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-3">Hướng dẫn sử dụng</h3>
            <ul class="text-sm text-gray-600 space-y-2">
                <li>• Nhập đầy đủ họ tên và số điện thoại</li>
                <li>• Nhấn "Lấy số" để nhận số thứ tự mới</li>
                <li>• Theo dõi số đang phục vụ ở trên</li>
                <li>• Chờ đến lượt của bạn</li>
                <li>• Số sẽ được cập nhật tự động</li>
                <li>• Mỗi lần lấy số đều cần nhập lại thông tin</li>
            </ul>
        </div>
    </div>
</body>
</html>
